<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Linear Timer App — Proportional Agenda (1-min Snap)</title>
<style>
:root{--bg:#f6f8fb;--card:#fff;--muted:#6b7a90;--accent:#0b66ff;}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;padding:22px;display:flex;justify-content:center;}
.wrap{width:100%;max-width:1100px}
.header{text-align:center;margin-bottom:12px}
h1{margin:0;font-size:20px}
.lead{color:var(--muted);margin-top:6px;font-size:14px}
.card{background:var(--card);padding:14px;border-radius:14px;box-shadow:0 10px 30px rgba(12,25,40,0.06)}
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
input,select,button{padding:8px;border-radius:10px;border:1px solid #e6eef8;font-size:14px}
input[type="color"]{padding:0;width:44px;height:36px;border:0}
button{background:var(--accent);color:#fff;border:0;cursor:pointer;border-radius:10px;padding:8px 12px}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.timers{display:flex;flex-direction:column;gap:16px;margin-top:12px}
.timer{padding:12px;border-radius:14px;background:#fff;box-shadow:0 8px 18px rgba(0,0,0,0.04);position:relative}
.timer-head{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.meta{color:var(--muted);font-size:13px}
.bar-area{padding:12px 8px 6px}
.ticks-top{position:relative;height:28px;margin-bottom:6px}
.tick-top{position:absolute;top:8px;width:1px;height:12px;background:#c8d2df}
.tick-top-label{position:absolute;top:0;transform:translateX(-50%);font-size:11px;color:#4b5868}
.bar-frame{position:relative;background:#eef2f7;border-radius:12px;overflow:visible;padding:10px}
.bar{height:var(--height,44px);border-radius:12px;position:relative;background:#f6f9fc;overflow:visible}
.bar-fill{position:absolute;left:0;top:0;height:100%;width:0;border-radius:12px;transition:width .12s linear}
.bar-text{position:absolute;left:12px;top:0;bottom:0;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-weight:800;color:#fff;pointer-events:none;font-size:14px}
.bar-text .right{color:#000}
.ticks-bottom{position:relative;height:36px;margin-top:10px}
.tick-btm{position:absolute;bottom:16px;width:1px;height:10px;background:#d7dee8}
.tick-btm-label{position:absolute;bottom:0;transform:translateX(-50%);font-size:11px;color:#4b5868}
.mins{display:flex;justify-content:space-between;margin-top:8px;font-weight:800}
.agenda-panel{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.agenda-inputs input[type="text"]{min-width:160px}
.agenda-item{position:absolute;top:-34px;padding:6px 8px;border-radius:10px;color:#fff;font-size:13px;cursor:grab;white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;overflow:hidden}
.agenda-line{position:absolute;top:-6px;width:2px;height:calc(100% + 12px);}
.controls .btn-ghost{background:#fff;color:var(--accent);border:1px solid #cfe0ff;padding:8px 10px;border-radius:10px;cursor:pointer}
.flex-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.open-now{margin-left:8px;background:#111;color:#fff;padding:8px 10px;border-radius:10px;border:0}
.now-panel{margin-top:14px;padding:12px;border-radius:12px;background:#fff;box-shadow:0 8px 18px rgba(0,0,0,0.06);color:#000}
.now-title{font-weight:900;font-size:18px;margin-bottom:8px}
.now-body{font-size:16px;font-weight:700}
@media (max-width:720px){ .bar-text{font-size:12px} .agenda-inputs input[type="text"]{min-width:120px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="header"><h1>Linear Timer App — Proportional Agenda (1‑minute snap)</h1><div class="lead">Drag items; they snap to 1 minute and can stack end‑to‑end. The "Now Happening" panel shows the current agenda item (left→right order).</div></div>

  <div class="card" role="region" aria-label="Create timer">
    <div class="controls">
      <input id="timerName" type="text" placeholder="Timer name (e.g., Period 1)" />
      <input id="timerStart" type="time" />
      <input id="timerEnd" type="time" />
      <input id="timerColor" type="color" value="#3b82f6" title="Bar color"/>
      <input id="timerHeight" type="number" value="44" min="12" max="120" title="Height (px)"/>
      <button id="addTimer">Add Timer</button>
      <button id="saveBtn" class="btn-ghost">Save</button>
      <button id="loadBtn" class="btn-ghost">Load</button>
      <button id="clearBtn" class="btn-ghost">Clear</button>
    </div>

    <div class="small">Top ticks = 10% increments. Bottom ticks = 5-minute increments (labels every 15 min). Agenda items snap to 1-minute grid and avoid overlap by stacking end-to-end.</div>

    <div id="timers" class="timers" aria-live="polite"></div>

    <div class="now-panel" id="nowPanel" style="display:none">
      <div class="now-title" id="nowTitle">Now Happening —</div>
      <div class="now-body" id="nowBody">No agenda items</div>
    </div>
  </div>
</div>

<script>
/* ---------- Utilities ---------- */
function timeToMinutes(hm){ const [h,m]=hm.split(':').map(Number); return h*60+m; }
function minutesToHM(min){ min = Math.round(min); min = ((min%1440)+1440)%1440; const h = Math.floor(min/60); const m = min%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
function format12(hm){ const [h,m]=hm.split(':').map(Number); const am = h<12; const hh = ((h+11)%12)+1; return `${hh}:${String(m).padStart(2,'0')} ${am?'AM':'PM'}`; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
function uid(prefix){ return prefix+'_'+Math.random().toString(36).slice(2,9); }

/* ---------- State ---------- */
let state = { timers: [] };

/* ---------- Persistence ---------- */
function saveState(){ localStorage.setItem('linearTimersV3', JSON.stringify(state)); alert('Saved locally'); }
function loadState(){ const s = localStorage.getItem('linearTimersV3'); if(s){ state = JSON.parse(s); renderAll(); alert('Loaded'); } else alert('No saved data'); }
function clearAll(){ if(!confirm('Clear all?')) return; state = {timers:[]}; renderAll(); localStorage.removeItem('linearTimersV3'); }

/* ---------- Timer CRUD ---------- */
function addTimerFromForm(){
  const name = document.getElementById('timerName').value.trim();
  const start = document.getElementById('timerStart').value;
  const end = document.getElementById('timerEnd').value;
  const color = document.getElementById('timerColor').value;
  const height = Number(document.getElementById('timerHeight').value) || 44;
  if(!name || !start || !end){ alert('Name, start and end required'); return; }
  const s = timeToMinutes(start), e = timeToMinutes(end);
  if(s===e){ alert('Start and end cannot be the same'); return; }
  const id = uid('t');
  state.timers.unshift({ id,name,start,end,s,e,color,height,agenda:[] });
  renderAll();
  document.getElementById('timerName').value='';
}

function removeTimer(id){ if(!confirm('Remove timer?')) return; state.timers = state.timers.filter(t=>t.id!==id); renderAll(); }

/* ---------- Agenda Handling ---------- */
function addAgenda(timerId, label, duration, color, fontColor){
  const timer = state.timers.find(t=>t.id===timerId); if(!timer) return;
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  if(duration <=0 || duration > dur){ alert('Duration must be >0 and <= timer duration'); return; }
  const aid = uid('a');
  // default offsetPct: place at end of existing items (stack)
  let usedPositions = timer.agenda.map(a => ({ startPct: a.offsetPct, widthPct: (a.duration/dur)*100 }));
  let endPct = 0;
  if(usedPositions.length){
    // find max(end)
    usedPositions.forEach(p=>{ endPct = Math.max(endPct, p.startPct + p.widthPct); });
  }
  const widthPct = (duration / dur) * 100;
  const initialOffset = clamp(endPct, 0, 100 - widthPct);
  timer.agenda.push({ id:aid, label, duration, color, fontColor:fontColor||'#ffffff', offsetPct: initialOffset });
  renderAll();
}

/* ---------- Snapping & stacking algorithm ---------- */
function snapAgendaPosition(timer, agendaId, desiredPct){
  // Snap desiredPct to nearest 1-minute increment then avoid overlap by stacking end-to-end if necessary.
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e); // minutes
  // Convert to minutes offset from start
  let desiredMinutes = Math.round((desiredPct/100) * dur); // snap to 1 minute
  desiredMinutes = clamp(desiredMinutes, 0, dur); // clamp
  // compute width in minutes for this agenda
  const ag = timer.agenda.find(a=>a.id===agendaId);
  if(!ag) return 0;
  const widthMin = ag.duration;
  // We'll try to place it so it doesn't overlap: try desiredMinutes, then shift right, then left
  // Build array of existing intervals excluding this agenda
  const intervals = timer.agenda.filter(a=>a.id!==agendaId).map(a=>{
    const start = Math.round((a.offsetPct/100)*dur);
    const end = start + a.duration;
    return {start,end};
  });
  // function to check overlap at candidate start
  function overlaps(start){
    const end = start + widthMin;
    if(start<0 || end>dur) return true;
    for(const iv of intervals){ if(!(end<=iv.start || start>=iv.end)) return true; }
    return false;
  }
  // round desiredMinutes to integer (already int)
  let candidate = desiredMinutes;
  // if fits, good
  if(!overlaps(candidate)) return (candidate/dur)*100;
  // else search outward for nearest non-overlapping position within bounds, prefer left then right?
  // We'll search increasing radius (0..dur)
  for(let r=1;r<=dur;r++){
    // try left
    let left = candidate - r;
    if(left>=0 && !overlaps(left)) return (left/dur)*100;
    // try right
    let right = candidate + r;
    if(right + widthMin <= dur && !overlaps(right)) return (right/dur)*100;
  }
  // fallback: place at end
  let endPos = 0;
  intervals.forEach(iv=> endPos = Math.max(endPos, iv.end));
  if(endPos + widthMin <= dur) return (endPos/dur)*100;
  // else place at 0
  return 0;
}

/* ---------- Dragging agenda items (constrained & snapping) ---------- */
function makeAgendaDraggable(el, timer){
  let dragging=false, barRect=null, itemWidth=0, pointerId=null;
  el.addEventListener('pointerdown', (ev)=>{
    ev.preventDefault();
    dragging=true; pointerId = ev.pointerId;
    el.setPointerCapture && el.setPointerCapture(pointerId);
    barRect = el.parentElement.getBoundingClientRect();
    itemWidth = el.offsetWidth;
  });
  window.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    const clientX = ev.clientX;
    let x = clientX - barRect.left - (itemWidth/2);
    const maxLeft = barRect.width - itemWidth;
    x = clamp(x, 0, maxLeft);
    const pct = (x / barRect.width) * 100;
    // live move (no overlap check yet)
    el.style.left = pct + '%';
  });
  el.addEventListener('pointerup', (ev)=>{
    if(!dragging) return;
    dragging=false;
    try{ el.releasePointerCapture && el.releasePointerCapture(pointerId); }catch(e){}
    // on release, snap and avoid overlaps
    const bar = el.parentElement;
    const barRect2 = bar.getBoundingClientRect();
    const currentLeft = parseFloat(el.style.left) || 0;
    // desiredPct based on currentLeft
    const desiredPct = currentLeft;
    const snappedPct = snapAgendaPosition(timer, el.dataset.aid, desiredPct);
    // ensure snappedPct keeps item inside (width considered in snap function)
    el.style.left = snappedPct + '%';
    // update model
    const agenda = timer.agenda.find(a=>a.id===el.dataset.aid);
    if(agenda){ agenda.offsetPct = snappedPct; agenda.timeHM = null; }
    // re-render to ensure perfect layout
    renderAll();
  });
}

/* ---------- Render & UI ---------- */
function renderTicksTop(container){
  container.innerHTML='';
  for(let i=0;i<=10;i++){
    const pct=i*10;
    const tick=document.createElement('div'); tick.className='tick-top'; tick.style.left=pct+'%'; container.appendChild(tick);
    const lbl=document.createElement('div'); lbl.className='tick-top-label'; lbl.style.left=pct+'%'; lbl.textContent=pct+'%'; container.appendChild(lbl);
  }
}
function renderTicksBottom(container,timer){
  container.innerHTML='';
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  const steps = Math.ceil(dur/5);
  for(let i=0;i<=steps;i++){
    const minutesFromStart = i*5;
    const pct = (minutesFromStart/dur)*100;
    const tick=document.createElement('div'); tick.className='tick-btm'; tick.style.left=pct+'%'; container.appendChild(tick);
    if(i%3===0){
      const lbl=document.createElement('div'); lbl.className='tick-btm-label'; lbl.style.left=pct+'%';
      let labelMin=(timer.s + minutesFromStart)%1440; const hh=Math.floor(labelMin/60), mm=labelMin%60;
      const ampm=hh<12?'AM':'PM'; const dispH=((hh+11)%12)+1; lbl.textContent=`${dispH}:${String(mm).padStart(2,'0')}${ampm}`;
      container.appendChild(lbl);
    }
  }
}

function renderAgendas(timer, barElement){
  // clear existing agenda DOM
  Array.from(barElement.querySelectorAll('.agenda-item, .agenda-line')).forEach(n=>n.remove());
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  timer.agenda.forEach(a=>{
    const widthPct = (a.duration / dur) * 100;
    const leftPct = clamp(a.offsetPct, 0, 100 - widthPct);
    const item = document.createElement('div');
    item.className='agenda-item'; item.dataset.aid = a.id;
    item.style.left = leftPct + '%'; item.style.width = `calc(${widthPct}% - 4px)`;
    item.style.background = a.color; item.style.color = a.fontColor || '#fff';
    item.innerHTML = `<span style="pointer-events:none">${a.label} (${a.duration}m)</span>`;
    barElement.appendChild(item);
    const line = document.createElement('div'); line.className='agenda-line'; line.style.left = (leftPct + widthPct/2)+'%'; line.style.background = a.color; barElement.appendChild(line);
    makeAgendaDraggable(item, timer);
  });
}

function renderAll(){
  const container = document.getElementById('timers'); container.innerHTML='';
  state.timers.forEach(timer=>{
    const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
    const outer=document.createElement('div'); outer.className='timer'; outer.id=timer.id;
    outer.innerHTML = `
      <div class="timer-head">
        <div>
          <div style="font-weight:900">${escapeHtml(timer.name)}</div>
          <div class="meta">${format12(timer.start)} → ${format12(timer.end)} • ${dur} min</div>
        </div>
        <div class="flex-row">
          <button class="btn-ghost" onclick="removeTimer('${timer.id}')">Remove</button>
          <button class="btn-ghost" onclick="openTimerWindow('${timer.id}')">Open display</button>
        </div>
      </div>
      <div class="bar-area">
        <div class="ticks-top" id="${timer.id}_top"></div>
        <div class="bar-frame" style="--height:${timer.height}px">
          <div class="bar" id="${timer.id}_bar" style="height:${timer.height}px">
            <div class="bar-fill" id="${timer.id}_fill" style="background:${timer.color};"></div>
            <div class="bar-text" id="${timer.id}_text"><div id="${timer.id}_left"></div><div class="right" id="${timer.id}_right"></div></div>
          </div>
        </div>
        <div class="ticks-bottom" id="${timer.id}_bottom"></div>
        <div class="mins"><div id="${timer.id}_gone">0 min gone</div><div id="${timer.id}_leftmin">0 min left</div></div>
        <div class="agenda-panel">
          <div class="agenda-inputs flex-row">
            <input type="text" id="${timer.id}_agenda_label" placeholder="Agenda label" />
            <input type="number" id="${timer.id}_agenda_dur" placeholder="Minutes" style="width:110px" />
            <input type="color" id="${timer.id}_agenda_color" value="#d33a3a" />
            <input type="color" id="${timer.id}_agenda_font" value="#ffffff" title="Font color" />
            <button onclick="handleAddAgenda('${timer.id}')">Add Agenda</button>
          </div>
        </div>
      </div>
    `;
    container.appendChild(outer);
    // render ticks and agendas
    renderTicksTop(document.getElementById(timer.id + '_top'));
    renderTicksBottom(document.getElementById(timer.id + '_bottom'), timer);
    const barEl = document.getElementById(timer.id + '_bar');
    renderAgendas(timer, barEl);
  });
  updateAll();
}

/* ---------- Add agenda handler ---------- */
function handleAddAgenda(timerId){
  const label = document.getElementById(timerId + '_agenda_label').value.trim();
  const dur = Number(document.getElementById(timerId + '_agenda_dur').value);
  const color = document.getElementById(timerId + '_agenda_color').value;
  const fcolor = document.getElementById(timerId + '_agenda_font').value;
  if(!label || !dur || isNaN(dur)){ alert('Label + duration required'); return; }
  addAgenda(timerId, label, dur, color, fcolor);
  document.getElementById(timerId + '_agenda_label').value='';
  document.getElementById(timerId + '_agenda_dur').value='';
  document.getElementById(timerId + '_agenda_color').value='#d33a3a';
  document.getElementById(timerId + '_agenda_font').value='#ffffff';
}

/* ---------- Now Happening logic (Option A: left->right order) ---------- */
function getOrderedAgendaList(timer){
  // build list of agendas ordered by left position (offsetPct). If equal, preserve array order.
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  const enriched = timer.agenda.map(a=>({...a, leftPct: a.offsetPct, widthPct: (a.duration/dur)*100}));
  enriched.sort((x,y)=> (x.leftPct - y.leftPct) || 0 );
  return enriched;
}

function updateNowPanel(){
  // find first timer with agendas and determine which agenda is current based on time elapsed through timer and agenda positions
  let found = false;
  for(const timer of state.timers){
    if(!timer.agenda || timer.agenda.length===0) continue;
    const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
    const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
    let since = (nowMin - timer.s + 1440) % 1440; if(since>dur) since = dur;
    // compute absolute minute within timer -> then map to left->right agenda placement
    // We'll compute agenda start minutes based on offsetPct * dur (rounded to minute)
    const ordered = getOrderedAgendaList(timer);
    const agendaStarts = ordered.map(a=> Math.round((a.offsetPct/100)*dur));
    // determine which agenda contains 'since' by checking start->start+duration
    for(let i=0;i<ordered.length;i++){
      const a = ordered[i]; const startMin = agendaStarts[i]; const endMin = startMin + a.duration;
      if(since >= startMin && since < endMin){
        // active agenda
        const elapsed = Math.floor(since - startMin); const remaining = Math.max(0, endMin - Math.ceil(since));
        showNowPanel(a.label, elapsed, remaining, Math.round(((since - startMin)/a.duration)*100));
        found = true; break;
      }
    }
    if(found) break;
  }
  if(!found) hideNowPanel();
}

function showNowPanel(label, elapsed, remaining, pct){
  const panel = document.getElementById('nowPanel'); panel.style.display='block';
  document.getElementById('nowTitle').textContent = `Now Happening — ${label}`;
  document.getElementById('nowBody').textContent = `${remaining} min left • ${pct}% complete`;
}
function hideNowPanel(){ const panel = document.getElementById('nowPanel'); panel.style.display='none'; }

/* ---------- Open display-only window (Option 1 style: large center display, white background) ---------- */
function openTimerWindow(timerId){
  const timer = state.timers.find(t=>t.id===timerId); if(!timer) return;
  const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
  // build agendas html
  let agendasHtml = '';
  const ordered = getOrderedAgendaList(timer);
  for(const a of ordered){
    const widthPct = (a.duration / dur) * 100;
    const leftPct = clamp(a.offsetPct, 0, 100 - widthPct);
    agendasHtml += `<div class="agenda-item" style="position:absolute;left:${leftPct}%;width:${widthPct}%;top:-40px;background:${a.color};color:${a.fontColor};border-radius:12px;padding:8px 10px;font-weight:800">${escapeHtml(a.label)} (${a.duration}m)</div>`;
    agendasHtml += `<div style="position:absolute;left:${leftPct + widthPct/2}%;width:2px;height:calc(100% + 12px);background:${a.color};top:-6px"></div>`;
  }
  const html = `
  <!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>${escapeHtml(timer.name)} — Now</title>
  <style>
    body{margin:0;background:#fff;color:#111;font-family:Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh}
    .frame{width:90%;max-width:1200px;text-align:center}
    h1{margin:0 0 6px;font-size:28px;font-weight:900}
    p{margin:0 0 14px;color:#444;font-size:16px}
    .bar-frame{position:relative;background:#f3f5f8;border-radius:18px;padding:28px}
    .bar{height:${timer.height}px;background:#eee;border-radius:14px;position:relative;overflow:visible}
    .bar-fill{position:absolute;left:0;top:0;height:100%;background:${timer.color};width:0;border-radius:14px}
    .bar-text{position:absolute;left:16px;top:0;bottom:0;display:flex;align-items:center;justify-content:space-between;padding:0 16px;font-weight:800;color:#111}
    .agenda-item{position:absolute;top:-52px;padding:8px 12px;border-radius:12px;color:#fff;font-weight:900;white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,0.12)}
  </style>
  </head><body>
    <div class="frame">
      <h1 id="title">Now Happening</h1>
      <p id="sub">Large display — live update</p>
      <div class="bar-frame">
        <div class="bar" id="bar">${agendasHtml}<div class="bar-fill" id="fill"></div><div class="bar-text"><div id="L"></div><div id="R"></div></div></div>
      </div>
    </div>
    <script>
      const dur = ${dur};
      const sMin = ${timer.s};
      function updateDisplay(){
        const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
        let since = (nowMin - sMin + 1440)%1440; if(since>dur) since = dur;
        const pct = Math.max(0,Math.min(100,(since/dur)*100));
        document.getElementById('fill').style.width = pct + '%';
        document.getElementById('L').textContent = pct.toFixed(1) + '%';
        document.getElementById('R').textContent = (100-pct).toFixed(1) + '%';
        // find current agenda
        const agendas = ${JSON.stringify(ordered)};
        for(let i=0;i<agendas.length;i++){
          const a = agendas[i];
          const start = Math.round((a.offsetPct/100)*dur);
          const end = start + a.duration;
          if(since >= start && since < end){
            document.getElementById('title').textContent = 'Now Happening — ' + a.label;
            const remaining = Math.max(0, end - Math.ceil(since));
            document.getElementById('sub').textContent = remaining + ' min left • ' + Math.round(((since - start)/a.duration)*100) + '% complete';
            break;
          } else {
            document.getElementById('title').textContent = 'Now Happening';
            document.getElementById('sub').textContent = 'No active agenda';
          }
        }
      }
      setInterval(updateDisplay,1000); updateDisplay();
    </script>
  </body></html>`;
  const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0,width=1000,height=500');
  w.document.write(html); w.document.close();
}

/* ---------- Update loop ---------- */
function updateAll(){
  const now = new Date(); const nowMin = now.getHours()*60 + now.getMinutes() + now.getSeconds()/60;
  state.timers.forEach(timer=>{
    const dur = (timer.e>=timer.s)?(timer.e-timer.s):(1440 - timer.s + timer.e);
    let since = (nowMin - timer.s + 1440) % 1440; if(since>dur) since = dur;
    const pct = clamp((since/dur)*100,0,100);
    const fill = document.getElementById(timer.id + '_fill'); if(fill){ fill.style.width = pct + '%'; fill.style.height = timer.height + 'px'; }
    const left = document.getElementById(timer.id + '_left'); const right = document.getElementById(timer.id + '_right');
    if(left) left.textContent = pct.toFixed(1) + '%'; if(right) right.textContent = (100-pct).toFixed(1) + '%';
    const goneEl = document.getElementById(timer.id + '_gone'); const leftEl = document.getElementById(timer.id + '_leftmin');
    const minsGone = Math.floor(Math.max(0, since)); const minsLeft = Math.ceil(Math.max(0, dur - since));
    if(goneEl) goneEl.textContent = minsGone + ' min gone'; if(leftEl) leftEl.textContent = minsLeft + ' min left';
    const barEl = document.getElementById(timer.id + '_bar');
    if(barEl) renderAgendas(timer, barEl);
  });
  updateNowPanel();
}

/* ---------- Helpers ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',\"'\":'&#39;' }[c])); }

/* ---------- Init ---------- */
document.getElementById('addTimer').addEventListener('click', addTimerFromForm);
document.getElementById('saveBtn').addEventListener('click', saveState);
document.getElementById('loadBtn').addEventListener('click', loadState);
document.getElementById('clearBtn').addEventListener('click', clearAll);

setInterval(updateAll,1000);

/* seed example if no saved state */
if(!localStorage.getItem('linearTimersV3')){
  state.timers.push({
    id: uid('t'), name: 'Example Period', start: '07:20', end: '08:10', s: timeToMinutes('07:20'), e: timeToMinutes('08:10'),
    color:'#3b82f6', height:44, agenda:[ { id: uid('a'), label:'Do Now', duration:10, color:'#f97316', fontColor:'#fff', offsetPct:5 },
      { id: uid('a'), label:'Direct Instr', duration:20, color:'#10b981', fontColor:'#fff', offsetPct:23 } ]
  });
  renderAll();
} else {
  loadState();
}
window.state = state;
window.renderAll = renderAll;
</script>
</body>
</html>
