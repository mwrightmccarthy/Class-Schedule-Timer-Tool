<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Linear Agenda Timer (Stable)</title>

<style>
body{
  margin:0;
  padding:24px;
  background:#f6f8fb;
  font-family:system-ui;
  display:flex;
  justify-content:center;
}

.container{width:100%;max-width:900px}

.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  box-shadow:0 8px 24px rgba(0,0,0,.1);
}

.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:12px;
}

input,button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #d1d5db;
}

button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}

.bar-frame{
  position:relative;
  height:44px;
  background:#e5e7eb;
  border-radius:12px;
  overflow:hidden;
}

.progress{
  position:absolute;
  left:0;
  top:0;
  height:100%;
  background:rgba(0,0,0,.35);
  width:0%;
  z-index:1;
}

.agenda-layer{
  position:absolute;
  inset:0;
  z-index:2;
}

.agenda-item{
  position:absolute;
  top:6px;
  height:32px;
  border-radius:8px;
  color:white;
  font-size:13px;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:grab;
  user-select:none;
}

.labels{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
  font-weight:700;
}
</style>
</head>

<body>
<div class="container">
<div class="card">

<div class="controls">
  <input id="start" type="time">
  <input id="end" type="time">
  <button onclick="startTimer()">Start Timer</button>
</div>

<div class="bar-frame" id="bar">
  <div class="progress" id="progress"></div>
  <div class="agenda-layer" id="agendaLayer"></div>
</div>

<div class="labels">
  <div id="elapsedText">0%</div>
  <div id="remainingText">100%</div>
</div>

<hr style="margin:16px 0">

<div class="controls">
  <input id="agendaLabel" placeholder="Agenda name">
  <input id="agendaMinutes" type="number" placeholder="Minutes">
  <input id="agendaColor" type="color" value="#f97316">
  <button onclick="addAgenda()">Add Agenda</button>
</div>

</div>
</div>

<script>
let startMin,endMin,totalMin;
let agendas=[];
const bar=document.getElementById('bar');
const agendaLayer=document.getElementById('agendaLayer');

function toMinutes(t){
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}

function startTimer(){
  startMin=toMinutes(start.value);
  endMin=toMinutes(end.value);
  totalMin=endMin-startMin;
  setInterval(updateProgress,1000);
}

function addAgenda(){
  const label=document.getElementById('agendaLabel').value.trim();
  const mins=Number(document.getElementById('agendaMinutes').value);
  const color=document.getElementById('agendaColor').value;

  if(!label||!mins||mins<=0) return;

  agendas.push({
    id:crypto.randomUUID(),
    label,
    mins,
    color,
    offset:agendas.reduce((s,a)=>s+a.mins,0)
  });

  renderAgendas();
}

function renderAgendas(){
  agendaLayer.innerHTML='';
  agendas.forEach(a=>{
    const el=document.createElement('div');
    el.className='agenda-item';
    el.textContent=a.label;
    el.style.background=a.color;
    el.style.width=(a.mins/totalMin*100)+'%';
    el.style.left=(a.offset/totalMin*100)+'%';
    makeDraggable(el,a);
    agendaLayer.appendChild(el);
  });
}

function makeDraggable(el,a){
  let startX,startOffset;

  el.onpointerdown=e=>{
    startX=e.clientX;
    startOffset=a.offset;
    el.setPointerCapture(e.pointerId);

    document.onpointermove=ev=>{
      const dx=ev.clientX-startX;
      const minsPerPx=totalMin/bar.offsetWidth;
      let newOffset=Math.round(startOffset+dx*minsPerPx);

      newOffset=Math.max(0,Math.min(totalMin-a.mins,newOffset));
      a.offset=newOffset;
      snapAgendas();
      renderAgendas();
    };

    document.onpointerup=()=>{
      document.onpointermove=null;
    };
  };
}

function snapAgendas(){
  agendas.sort((a,b)=>a.offset-b.offset);
  let cursor=0;
  agendas.forEach(a=>{
    a.offset=cursor;
    cursor+=a.mins;
  });
}

function updateProgress(){
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes()+now.getSeconds()/60;
  let elapsed=Math.max(0,Math.min(totalMin,nowMin-startMin));
  const pct=(elapsed/totalMin)*100;

  progress.style.width=pct+'%';
  elapsedText.textContent=pct.toFixed(1)+'% elapsed';
  remainingText.textContent=(100-pct).toFixed(1)+'% remaining';
}
</script>
</body>
</html>
